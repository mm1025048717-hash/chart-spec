<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>堆叠柱状图 - 文字优化设计规范</title>
    <script src="https://cdn.jsdelivr.net/npm/@antv/g2plot@2.4.31/dist/g2plot.min.js"></script>
    <link rel="stylesheet" href="../common.css">
    <style>
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto 32px;
        }
        @media (max-width: 900px) {
            .scenario-grid { grid-template-columns: 1fr; }
        }
        .chart-card.full-width { grid-column: span 2; }
        @media (max-width: 900px) {
            .chart-card.full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1>堆叠柱状图 - 文字优化设计规范</h1>
    <p class="subtitle">多维度数据对比展示，X轴标签智能处理 + 图例优化</p>
    <div class="tech-stack">
        <span class="tech-tag">Ant Design Charts</span>
        <span class="tech-tag">G2Plot</span>
        <span class="tech-tag">堆叠模式</span>
        <span class="tech-tag">图例截断</span>
    </div>
</div>

<!-- 规范说明 -->
<div class="spec-section">
    <div class="spec-title">堆叠柱状图特点</div>
    <table class="spec-table">
        <thead>
            <tr>
                <th>配置项</th>
                <th>说明</th>
                <th>推荐值</th>
                <th>代码配置</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><b>isStack</b></td>
                <td>开启堆叠模式</td>
                <td>true</td>
                <td><code>isStack: true</code></td>
            </tr>
            <tr>
                <td><b>seriesField</b></td>
                <td>分组字段（图例来源）</td>
                <td>-</td>
                <td><code>seriesField: 'type'</code></td>
            </tr>
            <tr>
                <td><b>图例位置</b></td>
                <td>图例显示位置</td>
                <td>top-right</td>
                <td><code>legend: { position: 'top-right' }</code></td>
            </tr>
            <tr class="highlight">
                <td><b>图例截断</b></td>
                <td>图例文字过长时截断</td>
                <td>10字符</td>
                <td><code>legend: { itemName: { formatter } }</code></td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 图表场景 -->
<div class="scenario-grid">

    <!-- 基础堆叠 -->
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-title">基础堆叠: 短分类名 + 短图例</span>
            <span class="chart-tag blue">标准配置</span>
        </div>
        <div class="chart-body">
            <div id="chart-basic" style="width: 100%; height: 100%;"></div>
            <div class="hover-hint">✨ 悬浮查看规范</div>
            
            <div class="annotation-layer">
                <div class="area-highlight legend-area" style="top: 10px; right: 10px; width: 200px; height: 30px;"></div>
                
                <div class="params-panel top-right">
                    <div class="params-panel-title">基础堆叠配置</div>
                    <div class="params-row">
                        <span class="label">isStack</span>
                        <span class="value highlight">true</span>
                    </div>
                    <div class="params-row">
                        <span class="label">seriesField</span>
                        <span class="value">'type'</span>
                    </div>
                    <div class="params-row">
                        <span class="label">columnWidthRatio</span>
                        <span class="value">0.5</span>
                    </div>
                    <div class="params-divider"></div>
                    <div class="params-section">图例配置</div>
                    <div class="params-row">
                        <span class="label">position</span>
                        <span class="value">top-right</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 长分类名 -->
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-title">场景2: 长分类名 - X轴45°倾斜</span>
            <span class="chart-tag green">rotate: -45°</span>
        </div>
        <div class="chart-body">
            <div id="chart-long-category" style="width: 100%; height: 100%;"></div>
            <div class="hover-hint">✨ 悬浮查看规范</div>
            
            <div class="annotation-layer">
                <div class="area-highlight xaxis-area" style="bottom: 0; left: 50px; right: 10px; height: 60px;"></div>
                
                <div class="params-panel top-right">
                    <div class="params-panel-title">长分类名配置</div>
                    <div class="params-row">
                        <span class="label">X轴rotate</span>
                        <span class="value highlight">-Math.PI/4</span>
                    </div>
                    <div class="params-row">
                        <span class="label">truncateAt</span>
                        <span class="value highlight">8</span>
                    </div>
                    <div class="params-divider"></div>
                    <div class="params-section">截断示例</div>
                    <div style="font-size: 10px; color: #999;">
                        "华东大区销售部" → "华东大区销..."
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 长图例 -->
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-title">场景3: 长图例名 - 图例截断</span>
            <span class="chart-tag yellow">legend truncate</span>
        </div>
        <div class="chart-body">
            <div id="chart-long-legend" style="width: 100%; height: 100%;"></div>
            <div class="hover-hint">✨ 悬浮查看规范</div>
            
            <div class="annotation-layer">
                <div class="area-highlight legend-area" style="top: 10px; right: 10px; width: 280px; height: 30px;"></div>
                
                <div class="params-panel top-right">
                    <div class="params-panel-title">图例截断配置</div>
                    <div class="params-row">
                        <span class="label">图例截断长度</span>
                        <span class="value highlight">10字符</span>
                    </div>
                    <div class="params-divider"></div>
                    <div class="params-section">代码配置</div>
                    <div style="font-size: 10px; color: #E6E8EB; font-family: monospace;">
                        legend: {<br>
                        &nbsp;&nbsp;itemName: {<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;formatter: (t) =><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.length > 10<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? t.slice(0,10)+'...'<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: t<br>
                        &nbsp;&nbsp;}<br>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 多系列 -->
    <div class="chart-card">
        <div class="chart-card-header">
            <span class="chart-title">场景4: 多系列 (≥5) - 图例换行</span>
            <span class="chart-tag red">多系列</span>
        </div>
        <div class="chart-body">
            <div id="chart-many-series" style="width: 100%; height: 100%;"></div>
            <div class="hover-hint">✨ 悬浮查看规范</div>
            
            <div class="annotation-layer">
                <div class="params-panel top-right">
                    <div class="params-panel-title">多系列配置</div>
                    <div class="params-row">
                        <span class="label">系列数量</span>
                        <span class="value highlight">≥5</span>
                    </div>
                    <div class="params-row">
                        <span class="label">图例位置</span>
                        <span class="value">top</span>
                    </div>
                    <div class="params-row">
                        <span class="label">图例布局</span>
                        <span class="value">horizontal</span>
                    </div>
                    <div class="params-divider"></div>
                    <div class="params-section">建议</div>
                    <div style="font-size: 10px; color: #999;">
                        系列过多时考虑图例换行<br>
                        或使用滚动图例
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 完整场景 -->
    <div class="chart-card full-width">
        <div class="chart-card-header">
            <span class="chart-title">真实场景: 各区域产品销售额堆叠对比</span>
            <span class="chart-tag blue">完整配置</span>
        </div>
        <div class="chart-meta">
            <div class="chart-meta-title">24年Q4各大区产品线销售额</div>
            <div class="chart-meta-info">
                <div class="chart-meta-item">
                    <span class="dot"></span>
                    <span>数据源: 销售流水表, 产品表</span>
                </div>
            </div>
        </div>
        <div class="chart-body lg">
            <div class="axis-unit y-left">万元</div>
            <div id="chart-real" style="width: 100%; height: 100%;"></div>
            <div class="hover-hint">✨ 悬浮查看完整规范</div>
            
            <div class="annotation-layer">
                <div class="area-highlight padding-area" style="top: 0; left: 0; right: 0; height: 50px;"></div>
                <div class="area-highlight xaxis-area" style="bottom: 0; left: 55px; right: 0; height: 70px;"></div>

                <div class="params-panel top-right">
                    <div class="params-panel-title">完整配置参数</div>
                    
                    <div class="params-section">堆叠配置</div>
                    <div class="params-row">
                        <span class="label">isStack</span>
                        <span class="value highlight">true</span>
                    </div>
                    <div class="params-row">
                        <span class="label">seriesField</span>
                        <span class="value">'product'</span>
                    </div>
                    
                    <div class="params-divider"></div>
                    <div class="params-section">柱状图配置</div>
                    <div class="params-row">
                        <span class="label">columnWidthRatio</span>
                        <span class="value">0.5</span>
                    </div>
                    <div class="params-row">
                        <span class="label">columnStyle.radius</span>
                        <span class="value">[4,4,0,0]</span>
                    </div>
                    
                    <div class="params-divider"></div>
                    <div class="params-section">X轴配置</div>
                    <div class="params-row">
                        <span class="label">rotate</span>
                        <span class="value highlight">-Math.PI/4</span>
                    </div>
                    <div class="params-row">
                        <span class="label">truncateAt</span>
                        <span class="value">8</span>
                    </div>
                    
                    <div class="params-divider"></div>
                    <div class="params-section">图例配置</div>
                    <div class="params-row">
                        <span class="label">position</span>
                        <span class="value">top-right</span>
                    </div>
                    <div class="params-row">
                        <span class="label">图例截断</span>
                        <span class="value">10字符</span>
                    </div>
                </div>

                <div class="code-panel" style="bottom: 80px; left: 70px; min-width: 320px;">
                    <div class="code-panel-title">关键代码配置</div>
                    <div>
                        <span style="color: #F97583;">isStack</span>: <span style="color: #79B8FF;">true</span>,<br>
                        <span style="color: #F97583;">seriesField</span>: <span style="color: #9ECBFF;">'product'</span>,<br>
                        <span style="color: #F97583;">legend</span>: {<br>
                        &nbsp;&nbsp;<span style="color: #FFAB70;">position</span>: <span style="color: #9ECBFF;">'top-right'</span>,<br>
                        &nbsp;&nbsp;<span style="color: #FFAB70;">itemName</span>: {<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #B392F0;">formatter</span>: (t) => t.length > <span style="color: #79B8FF;">10</span><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? t.slice(<span style="color: #79B8FF;">0</span>,<span style="color: #79B8FF;">10</span>)+<span style="color: #9ECBFF;">'...'</span> : t<br>
                        &nbsp;&nbsp;}<br>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="chart-summary">
            <span class="summary-item">
                <span class="summary-label">总计:</span>
                <span class="summary-value blue">2.4亿元</span>
            </span>
            <span class="summary-item">
                <span class="summary-label">区域数:</span>
                <span class="summary-value">6个</span>
            </span>
            <span class="summary-item">
                <span class="summary-label">产品线:</span>
                <span class="summary-value">4条</span>
            </span>
        </div>
    </div>

</div>

<!-- 代码示例 -->
<div class="spec-section">
    <div class="spec-title">完整代码实现</div>
    <div class="code-block">
<span class="comment">// 堆叠柱状图配置</span>
<span class="keyword">new</span> Column(<span class="string">'container'</span>, {
    data,
    xField: <span class="string">'region'</span>,
    yField: <span class="string">'value'</span>,
    seriesField: <span class="string">'product'</span>,     <span class="comment">// 分组字段</span>
    isStack: <span class="keyword">true</span>,                 <span class="comment">// 开启堆叠</span>
    
    <span class="comment">// 柱子配置</span>
    columnWidthRatio: <span class="number">0.5</span>,
    columnStyle: { radius: [<span class="number">4</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>] },
    
    <span class="comment">// X轴配置（智能处理）</span>
    xAxis: SmartXAxis.getConfig(data, <span class="string">'region'</span>),
    
    <span class="comment">// 图例配置（带截断）</span>
    legend: {
        position: <span class="string">'top-right'</span>,
        itemName: {
            formatter: (text) => {
                <span class="keyword">return</span> text.length > <span class="number">10</span> 
                    ? text.substring(<span class="number">0</span>, <span class="number">10</span>) + <span class="string">'...'</span> 
                    : text;
            }
        }
    },
    
    <span class="comment">// 颜色配置</span>
    color: [<span class="string">'#5B8FF9'</span>, <span class="string">'#5AD8A6'</span>, <span class="string">'#F6BD16'</span>, <span class="string">'#E86452'</span>],
    
    <span class="comment">// Tooltip - 显示完整信息</span>
    tooltip: {
        formatter: (datum) => ({
            name: datum.product,
            value: datum.value.toLocaleString() + <span class="string">' 万元'</span>
        })
    }
}).render();
    </div>
</div>

<script>
    const { Column } = G2Plot;

    // 视觉宽度计算
    function getVisualWidth(str) {
        let width = 0;
        for (let i = 0; i < str.length; i++) {
            const code = str.charCodeAt(i);
            if (code >= 0x4E00 && code <= 0x9FFF) width += 2;
            else width += 1;
        }
        return width;
    }

    // 智能X轴
    const SmartXAxis = {
        getConfig(data, xField) {
            const maxLen = Math.max(...data.map(d => getVisualWidth(String(d[xField] || ''))));
            const uniqueCount = [...new Set(data.map(d => d[xField]))].length;
            
            let rotate = 0, truncateAt = null;
            if (maxLen <= 4 && uniqueCount <= 8) {
                rotate = 0;
            } else if (maxLen <= 8) {
                rotate = -Math.PI / 4;
            } else {
                rotate = -Math.PI / 4;
                truncateAt = 8;
            }

            return {
                label: {
                    autoRotate: false,
                    rotate,
                    formatter: (text) => truncateAt && text.length > truncateAt 
                        ? text.substring(0, truncateAt) + '...' : text,
                    style: { fontSize: 11, fill: '#646A73', textAlign: rotate === 0 ? 'center' : 'end' }
                }
            };
        }
    };

    // 基础堆叠
    const basicData = [
        { region: '华东', type: '线上', value: 3650 },
        { region: '华东', type: '线下', value: 2100 },
        { region: '华北', type: '线上', value: 2808 },
        { region: '华北', type: '线下', value: 1900 },
        { region: '华南', type: '线上', value: 2408 },
        { region: '华南', type: '线下', value: 1600 },
        { region: '华中', type: '线上', value: 2236 },
        { region: '华中', type: '线下', value: 1400 },
    ];

    new Column('chart-basic', {
        data: basicData,
        xField: 'region',
        yField: 'value',
        seriesField: 'type',
        isStack: true,
        columnWidthRatio: 0.5,
        columnStyle: { radius: [4, 4, 0, 0] },
        color: ['#5B8FF9', '#5AD8A6'],
        legend: { position: 'top-right' },
        xAxis: SmartXAxis.getConfig(basicData, 'region'),
        yAxis: { title: { text: '万元', style: { fontSize: 11 } } },
    }).render();

    // 长分类名
    const longCategoryData = [
        { region: '华东大区销售部', type: '线上', value: 3650 },
        { region: '华东大区销售部', type: '线下', value: 2100 },
        { region: '华北大区销售部', type: '线上', value: 2808 },
        { region: '华北大区销售部', type: '线下', value: 1900 },
        { region: '华南大区销售部', type: '线上', value: 2408 },
        { region: '华南大区销售部', type: '线下', value: 1600 },
        { region: '西南大区销售部', type: '线上', value: 2000 },
        { region: '西南大区销售部', type: '线下', value: 1200 },
    ];

    new Column('chart-long-category', {
        data: longCategoryData,
        xField: 'region',
        yField: 'value',
        seriesField: 'type',
        isStack: true,
        columnWidthRatio: 0.5,
        color: ['#5AD8A6', '#F6BD16'],
        legend: { position: 'top-right' },
        xAxis: SmartXAxis.getConfig(longCategoryData, 'region'),
        yAxis: { title: { text: '万元', style: { fontSize: 11 } } },
    }).render();

    // 长图例
    const longLegendData = [
        { region: '华东', type: 'iPhone 15 Pro Max', value: 3650 },
        { region: '华东', type: 'MacBook Pro 16英寸', value: 2100 },
        { region: '华北', type: 'iPhone 15 Pro Max', value: 2808 },
        { region: '华北', type: 'MacBook Pro 16英寸', value: 1900 },
        { region: '华南', type: 'iPhone 15 Pro Max', value: 2408 },
        { region: '华南', type: 'MacBook Pro 16英寸', value: 1600 },
    ];

    new Column('chart-long-legend', {
        data: longLegendData,
        xField: 'region',
        yField: 'value',
        seriesField: 'type',
        isStack: true,
        columnWidthRatio: 0.5,
        color: ['#F6BD16', '#E86452'],
        legend: {
            position: 'top-right',
            itemName: {
                formatter: (text) => text.length > 10 ? text.substring(0, 10) + '...' : text
            }
        },
        xAxis: SmartXAxis.getConfig(longLegendData, 'region'),
        yAxis: { title: { text: '万元', style: { fontSize: 11 } } },
        tooltip: {
            formatter: (datum) => ({ name: datum.type, value: datum.value + ' 万元' })
        }
    }).render();

    // 多系列
    const manySeriesData = [];
    const regions = ['华东', '华北', '华南', '华中', '西北'];
    const products = ['手机', '电脑', '平板', '耳机', '手表', '配件'];
    regions.forEach(r => {
        products.forEach((p, i) => {
            manySeriesData.push({ region: r, type: p, value: Math.floor(Math.random() * 2000) + 500 });
        });
    });

    new Column('chart-many-series', {
        data: manySeriesData,
        xField: 'region',
        yField: 'value',
        seriesField: 'type',
        isStack: true,
        columnWidthRatio: 0.5,
        color: ['#5B8FF9', '#5AD8A6', '#F6BD16', '#E86452', '#9270CA', '#6DC8EC'],
        legend: { position: 'top', layout: 'horizontal' },
        xAxis: SmartXAxis.getConfig(manySeriesData, 'region'),
        yAxis: { title: { text: '万元', style: { fontSize: 11 } } },
    }).render();

    // 真实场景
    const realData = [
        { region: '华东大区', product: 'iPhone系列', value: 5200 },
        { region: '华东大区', product: 'Mac系列', value: 3800 },
        { region: '华东大区', product: 'iPad系列', value: 2400 },
        { region: '华东大区', product: '配件周边', value: 1200 },
        { region: '华北大区', product: 'iPhone系列', value: 4100 },
        { region: '华北大区', product: 'Mac系列', value: 2900 },
        { region: '华北大区', product: 'iPad系列', value: 1800 },
        { region: '华北大区', product: '配件周边', value: 900 },
        { region: '华南大区', product: 'iPhone系列', value: 3800 },
        { region: '华南大区', product: 'Mac系列', value: 2600 },
        { region: '华南大区', product: 'iPad系列', value: 1600 },
        { region: '华南大区', product: '配件周边', value: 800 },
        { region: '华中大区', product: 'iPhone系列', value: 2900 },
        { region: '华中大区', product: 'Mac系列', value: 2000 },
        { region: '华中大区', product: 'iPad系列', value: 1200 },
        { region: '华中大区', product: '配件周边', value: 600 },
        { region: '西北大区', product: 'iPhone系列', value: 1800 },
        { region: '西北大区', product: 'Mac系列', value: 1200 },
        { region: '西北大区', product: 'iPad系列', value: 800 },
        { region: '西北大区', product: '配件周边', value: 400 },
        { region: '西南大区', product: 'iPhone系列', value: 2200 },
        { region: '西南大区', product: 'Mac系列', value: 1500 },
        { region: '西南大区', product: 'iPad系列', value: 1000 },
        { region: '西南大区', product: '配件周边', value: 500 },
    ];

    new Column('chart-real', {
        data: realData,
        xField: 'region',
        yField: 'value',
        seriesField: 'product',
        isStack: true,
        columnWidthRatio: 0.5,
        columnStyle: { radius: [4, 4, 0, 0] },
        color: ['#5B8FF9', '#5AD8A6', '#F6BD16', '#E86452'],
        legend: {
            position: 'top-right',
            itemName: {
                formatter: (text) => text.length > 10 ? text.substring(0, 10) + '...' : text
            }
        },
        xAxis: SmartXAxis.getConfig(realData, 'region'),
        yAxis: {
            title: { text: '销售额', style: { fontSize: 12 } },
            label: { formatter: (v) => (v / 1000).toFixed(0) + 'k' }
        },
        tooltip: {
            formatter: (datum) => ({ name: datum.product, value: datum.value.toLocaleString() + ' 万元' })
        }
    }).render();
</script>


<script src="../nav.js"></script>
</body>
</html>
